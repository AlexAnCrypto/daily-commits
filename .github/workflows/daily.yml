name: Daily Quote Commit (Random time + Sequential)

on:
  schedule:
    - cron: "0 0 * * *"   # старт каждый день в 00:00 UTC
  workflow_dispatch:

jobs:
  commit-quote:
    runs-on: ubuntu-latest
    steps:
      - name: Random delay (0-12 hours)
        run: |
          # случайная задержка до 12 часов (43200 секунд)
          DELAY=$(( RANDOM % 43200 ))
          echo "Sleeping for $DELAY seconds (= $((DELAY/3600)) hours)"
          sleep $DELAY

      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Ensure counter exists
        run: |
          # если нет counter.txt — создаём со значением 1
          if [ ! -f counter.txt ]; then echo 1 > counter.txt; fi

      - name: Select next quote sequentially
        run: |
          # считаем количество цитат — строки, которые не пустые
          TOTAL_QUOTES=$(grep -cve '^[[:space:]]*$' quotes.txt || true)
          if [ -z "$TOTAL_QUOTES" ] || [ "$TOTAL_QUOTES" -lt 1 ]; then
            echo "No quotes found in quotes.txt; exiting" && exit 1
          fi

          CURRENT=$(cat counter.txt | tr -d '[:space:]')
          if ! echo "$CURRENT" | grep -qE '^[0-9]+$'; then CURRENT=1; fi

          # на случай, если counter вышел за границы
          if [ "$CURRENT" -gt "$TOTAL_QUOTES" ]; then CURRENT=1; fi

          # берем N-ю непустую строку из quotes.txt
          QUOTE=$(grep -ve '^[[:space:]]*$' quotes.txt | sed -n "${CURRENT}p")

          echo "$QUOTE" > daily.txt
          echo "Selected quote (#${CURRENT}/${TOTAL_QUOTES}): $QUOTE"

          # увеличиваем счётчик
          NEXT=$((CURRENT + 1))
          if [ $NEXT -gt $TOTAL_QUOTES ]; then NEXT=1; fi
          echo $NEXT > counter.txt

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add daily.txt counter.txt
          git commit -m "Daily quote #$(cat counter.txt)" || echo "Nothing to commit"
          git push
