name: Daily Quote Commit (Random time + Sequential)

permissions:
  contents: write

on:
  schedule:
    - cron: "0 5 * * *"   # ежедневно в 05:00 UTC (с задержкой внутри)
  workflow_dispatch:

jobs:
  update-quote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Random delay up to 3 hours
        run: |
          DELAY=$(( RANDOM % 10800 ))
          echo "Sleeping for $DELAY seconds (~$((DELAY/3600)) hours)"
          sleep $DELAY

      - name: Ensure counter file exists
        run: |
          if [ ! -f counter.txt ]; then echo "1" > counter.txt; fi

      - name: Select next quote
        run: |
          QUOTES_FILE="quotes.txt"
          COUNTER_FILE="counter.txt"

          total=$(grep -cve '^[[:space:]]*$' "$QUOTES_FILE")
          current=$(cat "$COUNTER_FILE" | tr -d '[:space:]')
          if [ "$current" -gt "$total" ] || [ "$current" -lt 1 ]; then
            current=1
          fi

          quote=$(grep -ve '^[[:space:]]*$' "$QUOTES_FILE" | sed -n "${current}p")
          echo "$quote" > daily.txt

          next=$(( current + 1 ))
          if [ "$next" -gt "$total" ]; then
            next=1
          fi
          echo "$next" > "$COUNTER_FILE"

      - name: Commit and push changes
        run: |
          git config user.name "AlexAnCrypto"
          git config user.email "240292681+AlexAnCrypto@users.noreply.github.com"

          git add daily.txt counter.txt
          git commit -m "Daily quote update" || echo "Nothing to commit"
          git push
